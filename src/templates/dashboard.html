<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Escalation Monitor</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <link rel="apple-touch-icon" sizes="192x192" href="/favicon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="/favicon-512.png" />
  <link href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta20/dist/css/tabler.min.css" rel="stylesheet" />
  <link href="/dashboard.css" rel="stylesheet" />
</head>
<body>
<div class="page">
  <!-- User Header -->
  {% if user_email %}
  <div class="user-header">
    <div class="container-narrow">
      <div class="user-info">
        <span class="user-email">{{ user_email }}</span>
        <a href="/logout" class="logout-btn">Abmelden</a>
      </div>
    </div>
  </div>
  {% endif %}

  <div class="container-narrow py-4">

    <!-- Disclaimer -->
    <div class="card card-md mb-3">
      <div class="card-body d-flex align-items-start">
        <!-- gelbes Dreieck mit schwarzem ! -->
        <svg class="warn-ic me-2" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M12 3 22 21H2z" fill="#facc15" stroke="#d4af0d" stroke-width="1.5"/>
          <rect x="11" y="8" width="2" height="7" rx="1" fill="#111827"/>
          <rect x="11" y="17" width="2" height="2" rx=".8" fill="#111827"/>
        </svg>
        <div>
          <div class="fw-bold">Hinweis zur KI-generierten Analyse</div>
          <div class="text-secondary">Dieses Dashboard wird von einer KI erstellt, die auf öffentlich verfügbaren Informationen basiert. Die KI durchsucht Web-Quellen und RSS-Feeds, vergleicht verschiedene Perspektiven und berechnet einen Eskalationsscore nach festgelegten Kriterien. KI-Systeme können jedoch fehlerhafte Schlüsse ziehen, Kontext missverstehen oder von Fehlinformationen getäuscht werden. Die Bewertung dient ausschließlich zu Informationszwecken. Verwendung auf eigene Verantwortung.</div>
          <div class="mt-2">
            <a href="#legalNotice" class="text-decoration-none" data-bs-toggle="collapse" role="button" aria-expanded="false" aria-controls="legalNotice">
              <small>Rechtlicher Hinweis</small> <i class="ti ti-chevron-down"></i>
            </a>
            <div class="collapse mt-2" id="legalNotice">
              <div class="small text-muted">
                <strong>Rechtlicher Hinweis</strong><br><br>
                Die vorliegende Analyse wurde vollautomatisch mittels KI-Technologie auf Basis öffentlich zugänglicher Quellen erstellt. Es erfolgt keine manuelle Prüfung der Ergebnisse. Die Bewertungen stellen keine verbindlichen Einschätzungen dar. Trotz sorgfältiger Programmierung können Fehler, Ungenauigkeiten oder Fehlinterpretationen auftreten. Die Nutzung erfolgt auf eigenes Risiko. Es wird keine Gewähr für Aktualität, Richtigkeit und Vollständigkeit übernommen. Der Betreiber haftet nicht für Schäden, die aus der Nutzung dieser Informationen entstehen.
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Warning for old data -->
    {% if report and report.age_days and report.age_days > 0 %}
    <div class="alert alert-warning mb-3" role="alert">
      <div class="d-flex align-items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon alert-icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
          <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
          <path d="M12 9v4"/>
          <path d="M10.363 3.591l-8.106 13.534a1.914 1.914 0 0 0 1.636 2.871h16.214a1.914 1.914 0 0 0 1.636 -2.87l-8.106 -13.536a1.914 1.914 0 0 0 -3.274 0z"/>
          <path d="M12 16h.01"/>
        </svg>
        <div>
          <strong>Achtung:</strong>
          {% if report.age_days == 1 %}
          Dies sind die Daten von gestern ({{ report.date }}) – der heutige Bericht ist noch nicht verfügbar.
          {% else %}
          Dies sind die Daten von vor {{ report.age_days }} Tagen ({{ report.date }}) – ein aktuellerer Bericht ist noch nicht verfügbar.
          {% endif %}
        </div>
      </div>
    </div>
    {% endif %}

    <div class="row g-3">
      <!-- Links: Score + Summary -->
      <div class="col-12 col-lg-8">
        <!-- Score/Level/Trend -->
        <div class="card mb-3">
          <div class="card-body">
            <div class="score-wrap">
              <div class="score-big" id="scoreBig">
                {% if report and report.escalation_result and report.escalation_result.escalation_score %}
                  {{ report.escalation_result.escalation_score.score|round(1)|replace('.', ',') }}
                {% else %}
                  1,0
                {% endif %}
              </div>

              <div class="right-info">
                <div class="mb-1">
                  <span class="badge badge-soft-{{ (report.escalation_result.escalation_score.level|lower) if report and report.escalation_result and report.escalation_result.escalation_score else 'baseline' }}" id="levelBadge">
                    {{ report.escalation_result.escalation_score.level if report and report.escalation_result and report.escalation_result.escalation_score else 'BASELINE' }}
                  </span>
                </div>
                <div class="text-secondary small mt-2" id="metaDate">Stand: {{ formatted_timestamp }}</div>
              </div>
            </div>

            <!-- Summary -->
            {% if report and report.escalation_result and report.escalation_result.escalation_score and report.escalation_result.escalation_score.summary %}
            <div class="summary-section mt-3 pt-3 border-top">
              <div class="summary-text" id="summaryContent"></div>
              <script id="summaryData" type="application/json">{{ report.escalation_result.escalation_score.summary|tojson }}</script>
            </div>
            {% endif %}
          </div>
        </div>

      </div>

      <!-- Rechts: Skala + Dimensionen -->
      <div class="col-12 col-lg-4">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Skala</h3>
          </div>
          <div class="card-body">
            <div class="scale-text" id="scaleText">
              {% for level in scale_levels %}
              <p {% if report and report.escalation_result and report.escalation_result.escalation_score and level.number == (report.escalation_result.escalation_score.score|int) %}class="is-current"{% endif %}>
                <span class="level-label">{{ level.number }} {{ level.label }}</span><span class="muted"> — {{ level.description }}</span>
              </p>
              {% endfor %}
            </div>
          </div>

          <!-- Dimensions Accordion in gleicher Card -->
          {% if report and report.escalation_result and report.escalation_result.escalation_score and report.escalation_result.escalation_score.dimensions %}
          <div class="card-header border-top">
            <h3 class="card-title">Dimensionen</h3>
          </div>
          <div class="card-body">
            <div class="dimensions-accordion">
              {% for dim in report.escalation_result.escalation_score.dimensions %}
              <div class="dim-accordion-item">
                <div class="dim-accordion-header" onclick="toggleDimension(this)">
                  <span>{{ dim.name }} ({{ dim.score }}/10)</span>
                  <svg class="dim-accordion-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                  </svg>
                </div>
                <div class="dim-accordion-body" data-rationale-md="{{ dim.rationale|tojson|forceescape }}">
                  <!-- Content wird via JavaScript gerendert -->
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

  </div>

  <!-- Footer Placeholder -->
  <div id="footer-placeholder"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta20/dist/js/tabler.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
<script src="/footer.js"></script>
<script>
  // Dimensions Accordion Toggle
  function toggleDimension(header) {
    const body = header.nextElementSibling;
    const isActive = body.classList.contains('active');

    // Close all
    document.querySelectorAll('.dim-accordion-body').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.dim-accordion-header').forEach(h => h.classList.remove('active'));

    // Open clicked if was closed
    if (!isActive) {
      body.classList.add('active');
      header.classList.add('active');
    }
  }

  // Color interpolation für Score-Anzeige
  function lerpColor(hex1, hex2, t){
    const a = hex1.match(/\w\w/g).map(x=>parseInt(x,16));
    const b = hex2.match(/\w\w/g).map(x=>parseInt(x,16));
    const c = a.map((v,i)=>Math.round(v+(b[i]-v)*t));
    return '#'+c.map(v=>v.toString(16).padStart(2,'0')).join('');
  }

  // Score-Farbe berechnen (Grau -> Rot basierend auf Score)
  {% if report and report.escalation_result and report.escalation_result.escalation_score %}
  const score = {{ report.escalation_result.escalation_score.score }};
  const t = (score - 1) / 9;
  const colorNow = lerpColor('94a3b8', 'dc2626', Math.min(1,Math.max(0,t)));

  // Score-Farbe anwenden
  document.getElementById("scoreBig").style.color = colorNow;

  // Current level markieren - gesamten Text einfärben
  const currentLevel = Math.floor(score);
  const scaleElements = document.querySelectorAll('.scale-text .is-current');
  scaleElements.forEach(el => {
    el.style.color = colorNow;
    // Alle child elements (spans) ebenfalls einfärben für einheitliche Darstellung
    const spans = el.querySelectorAll('span');
    spans.forEach(span => {
      span.style.color = colorNow;
    });
  });

  {% else %}
  // Fallback: Score 1.0 in grau
  document.getElementById("scoreBig").style.color = '#94a3b8';
  {% endif %}

  // Helper: Strip HTML tags from LLM output
  function stripHtmlTags(text) {
    return text.replace(/<[^>]*>/g, '');
  }

  // Configure marked.js to render line breaks
  marked.use({
    breaks: true,
    gfm: true
  });

  // Render Summary Markdown (nach marked.js geladen ist)
  const summaryDataEl = document.getElementById('summaryData');
  if (summaryDataEl) {
    const summaryMarkdown = JSON.parse(summaryDataEl.textContent);
    document.getElementById('summaryContent').innerHTML = marked.parse(summaryMarkdown);
  }

  // Render Dimension Rationales (strip HTML tags + Markdown)
  document.querySelectorAll('.dim-accordion-body[data-rationale-md]').forEach(body => {
    const rationaleRaw = JSON.parse(body.dataset.rationaleMd);
    const rationaleClean = stripHtmlTags(rationaleRaw);
    body.innerHTML = marked.parse(rationaleClean);
  });

  // Load footer
  fetch('/footer.html')
    .then(r => r.text())
    .then(html => {
      document.getElementById('footer-placeholder').innerHTML = html;
    })
    .catch(err => console.error('Failed to load footer:', err));
</script>
</body>
</html>