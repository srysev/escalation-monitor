<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Eskalations-Dashboard · Escalation Monitor</title>
  <link href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta20/dist/css/tabler.min.css" rel="stylesheet" />
  <style>
    :root{
      --muted:#64748b;
      --current-bg:#fff7ed;
    }
    body{ background:#f8fafc; }
    .container-narrow{ max-width: 1024px; }

    /* Kopf */
    .score-wrap{ display:flex; align-items:flex-start; gap:24px; }
    .score-big{
      font: 800 64px/1 "JetBrains Mono", ui-monospace, Menlo, monospace;
      font-variant-numeric: tabular-nums; white-space:nowrap; letter-spacing:0;
      color:#111827;
    }
    .right-info{ min-width: 220px; }
    .badge-soft-high{ background:#fee2e2; color:#991b1b; border:1px solid #fecaca; }
    .badge-soft-critical{ background:#fef2f2; color:#991b1b; border:1px solid #fca5a5; }
    .badge-soft-severe{ background:#fef2f2; color:#7f1d1d; border:1px solid #f87171; }
    .badge-soft-elevated{ background:#fef3c7; color:#92400e; border:1px solid #fcd34d; }
    .badge-soft-alert{ background:#fef3c7; color:#78350f; border:1px solid #f59e0b; }
    .badge-soft-baseline{ background:#f0fdf4; color:#166534; border:1px solid #bbf7d0; }

    .trend-block{ color: inherit; font-weight:600; }
    .trend-block label{ display:block; color:var(--muted); font-weight:500; margin-bottom:2px }
    .trend-block .arrow{ display:inline-block; transform: translateY(2px); }

    /* Kritische Indikatoren */
    .indicators{
      max-height: 360px; overflow:auto;
      scrollbar-gutter: stable;
    }
    .list-tight .list-group-item{ padding:.7rem .9rem }
    .list-group-item .src{ color:var(--muted) }

    /* Category Badge */
    .list-group-item .badge{ white-space: nowrap; }

    /* Skala als Text: jede Stufe = eigene Zeile */
    .scale-text p{ margin:.35rem 0; color: #6b7280; font-weight: 500; }
    .scale-text .muted{ color: inherit; }
    .scale-text .is-current{ font-weight:800; }

    /* großes Warn-Icon */
    .warn-ic{ width:28px; height:28px; flex:none; }

    /* Summary in Score-Karte */
    .summary-section{ border-color: #e5e7eb; }
    .summary-title{ font-size: 16px; font-weight: 600; color: #111827; margin-bottom: 12px; }
    .summary-text{ color: #374151; font-size: 14px; line-height: 1.6; }
    .summary-text h2 { font-size: 16px; font-weight: 700; margin-top: 20px; margin-bottom: 8px; color: #111827; }
    .summary-text h3 { font-size: 15px; font-weight: 600; margin-top: 16px; margin-bottom: 6px; color: #374151; }
    .summary-text p { margin-bottom: 12px; }
    .summary-text strong { font-weight: 600; color: #111827; }

    /* Card-Titel konsistent mit Summary-Styling */
    .card-title{ font-size: 16px; font-weight: 600; color: #111827; }

    /* Trend Section */
    .trend-section{ border-color: #e5e7eb; }
    .trend-label{
      font-size: 13px;
      font-weight: 600;
      color: #6b7280;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .trend-text{
      color: #374151;
      font-size: 14px;
      line-height: 1.6;
      font-weight: 500;
    }

    /* Dimensions Accordion */
    .dimensions-accordion{ margin-top: 16px; }
    .dim-accordion-item{
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      margin-bottom: 8px;
      overflow: hidden;
    }
    .dim-accordion-header{
      padding: 12px 16px;
      cursor: pointer;
      background: #f8f9fa;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      color: #374151;
      user-select: none;
    }
    .dim-accordion-header:hover{ background: #e9ecef; }
    .dim-accordion-body{
      padding: 16px;
      background: white;
      font-size: 14px;
      line-height: 1.6;
      color: #374151;
      display: none;
    }
    .dim-accordion-body.active{ display: block; }
    .dim-accordion-chevron{
      transition: transform 0.2s;
      width: 16px;
      height: 16px;
    }
    .dim-accordion-header.active .dim-accordion-chevron{ transform: rotate(180deg); }
  </style>
</head>
<body>
<div class="page">
  <div class="container-narrow py-4">

    <!-- Disclaimer -->
    <div class="card card-md mb-3">
      <div class="card-body d-flex align-items-start">
        <!-- gelbes Dreieck mit schwarzem ! -->
        <svg class="warn-ic me-2" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M12 3 22 21H2z" fill="#facc15" stroke="#d4af0d" stroke-width="1.5"/>
          <rect x="11" y="8" width="2" height="7" rx="1" fill="#111827"/>
          <rect x="11" y="17" width="2" height="2" rx=".8" fill="#111827"/>
        </svg>
        <div>
          <div class="fw-bold">Hinweis zur KI-generierten Analyse</div>
          <div class="text-secondary">Dieses Dashboard wird von einer KI erstellt, die auf öffentlich verfügbaren Informationen basiert. Die KI durchsucht Web-Quellen und RSS-Feeds, vergleicht verschiedene Perspektiven und berechnet einen Eskalationsscore nach festgelegten Kriterien. KI-Systeme können jedoch fehlerhafte Schlüsse ziehen, Kontext missverstehen oder von Fehlinformationen getäuscht werden. Die Bewertung dient ausschließlich zu Informationszwecken. Verwendung auf eigene Verantwortung.</div>
          <div class="mt-2">
            <a href="#legalNotice" class="text-decoration-none" data-bs-toggle="collapse" role="button" aria-expanded="false" aria-controls="legalNotice">
              <small>Rechtlicher Hinweis</small> <i class="ti ti-chevron-down"></i>
            </a>
            <div class="collapse mt-2" id="legalNotice">
              <div class="small text-muted">
                <strong>Rechtlicher Hinweis</strong><br><br>
                Die vorliegende Analyse wurde vollautomatisch mittels KI-Technologie auf Basis öffentlich zugänglicher Quellen erstellt. Es erfolgt keine manuelle Prüfung der Ergebnisse. Die Bewertungen stellen keine verbindlichen Einschätzungen dar. Trotz sorgfältiger Programmierung können Fehler, Ungenauigkeiten oder Fehlinterpretationen auftreten. Die Nutzung erfolgt auf eigenes Risiko. Es wird keine Gewähr für Aktualität, Richtigkeit und Vollständigkeit übernommen. Der Betreiber haftet nicht für Schäden, die aus der Nutzung dieser Informationen entstehen.
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Warning for old data -->
    {% if report and report.age_days and report.age_days > 0 %}
    <div class="alert alert-warning mb-3" role="alert">
      <div class="d-flex align-items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon alert-icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
          <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
          <path d="M12 9v4"/>
          <path d="M10.363 3.591l-8.106 13.534a1.914 1.914 0 0 0 1.636 2.871h16.214a1.914 1.914 0 0 0 1.636 -2.87l-8.106 -13.536a1.914 1.914 0 0 0 -3.274 0z"/>
          <path d="M12 16h.01"/>
        </svg>
        <div>
          <strong>Achtung:</strong>
          {% if report.age_days == 1 %}
          Dies sind die Daten von gestern ({{ report.date }}) – der heutige Bericht ist noch nicht verfügbar.
          {% else %}
          Dies sind die Daten von vor {{ report.age_days }} Tagen ({{ report.date }}) – ein aktuellerer Bericht ist noch nicht verfügbar.
          {% endif %}
        </div>
      </div>
    </div>
    {% endif %}

    <div class="row g-3">
      <!-- Links: Score + Summary -->
      <div class="col-12 col-lg-8">
        <!-- Score/Level/Trend -->
        <div class="card mb-3">
          <div class="card-body">
            <div class="score-wrap">
              <div class="score-big" id="scoreBig">
                {% if report and report.escalation_result and report.escalation_result.escalation_score %}
                  {{ report.escalation_result.escalation_score.score|round(1)|replace('.', ',') }}
                {% else %}
                  1,0
                {% endif %}
              </div>

              <div class="right-info">
                <div class="mb-1">
                  <span class="badge badge-soft-{{ (report.escalation_result.escalation_score.level|lower) if report and report.escalation_result and report.escalation_result.escalation_score else 'baseline' }}" id="levelBadge">
                    {{ report.escalation_result.escalation_score.level if report and report.escalation_result and report.escalation_result.escalation_score else 'BASELINE' }}
                  </span>
                </div>
                <div class="text-secondary small mt-2" id="metaDate">Stand: {{ formatted_timestamp }}</div>
              </div>
            </div>

            <!-- Trend Assessment -->
            {% if report and report.escalation_result and report.escalation_result.escalation_score and report.escalation_result.escalation_score.trend_assessment %}
            <div class="trend-section mt-3 pt-3 border-top">
              <div class="trend-label">Trend</div>
              <div class="trend-text" id="trendContent"></div>
              <script id="trendData" type="application/json">{{ report.escalation_result.escalation_score.trend_assessment|tojson }}</script>
            </div>
            {% endif %}

            <!-- Summary -->
            {% if report and report.escalation_result and report.escalation_result.escalation_score and report.escalation_result.escalation_score.summary %}
            <div class="summary-section mt-3 pt-3 border-top">
              <div class="summary-text" id="summaryContent"></div>
              <script id="summaryData" type="application/json">{{ report.escalation_result.escalation_score.summary|tojson }}</script>
            </div>
            {% endif %}
          </div>
        </div>

      </div>

      <!-- Rechts: Skala + Dimensionen -->
      <div class="col-12 col-lg-4">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Skala</h3>
          </div>
          <div class="card-body">
            <div class="scale-text" id="scaleText">
              {% for level in scale_levels %}
              <p {% if report and report.escalation_result and report.escalation_result.escalation_score and level.number == (report.escalation_result.escalation_score.score|round|int) %}class="is-current"{% endif %}>
                <span class="level-label">{{ level.number }} {{ level.label }}</span><span class="muted"> — {{ level.description }}</span>
              </p>
              {% endfor %}
            </div>
          </div>

          <!-- Dimensions Accordion in gleicher Card -->
          {% if report and report.escalation_result and report.escalation_result.escalation_score and report.escalation_result.escalation_score.dimensions %}
          <div class="card-header border-top">
            <h3 class="card-title">Dimensionen</h3>
          </div>
          <div class="card-body">
            <div class="dimensions-accordion">
              {% for dim in report.escalation_result.escalation_score.dimensions %}
              <div class="dim-accordion-item">
                <div class="dim-accordion-header" onclick="toggleDimension(this)">
                  <span>{{ dim.name }} ({{ dim.score }}/10)</span>
                  <svg class="dim-accordion-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                  </svg>
                </div>
                <div class="dim-accordion-body" data-rationale-md="{{ dim.rationale|tojson|forceescape }}">
                  <!-- Content wird via JavaScript gerendert -->
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta20/dist/js/tabler.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
<script>
  // Dimensions Accordion Toggle
  function toggleDimension(header) {
    const body = header.nextElementSibling;
    const isActive = body.classList.contains('active');

    // Close all
    document.querySelectorAll('.dim-accordion-body').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.dim-accordion-header').forEach(h => h.classList.remove('active'));

    // Open clicked if was closed
    if (!isActive) {
      body.classList.add('active');
      header.classList.add('active');
    }
  }

  // Color interpolation für Score-Anzeige
  function lerpColor(hex1, hex2, t){
    const a = hex1.match(/\w\w/g).map(x=>parseInt(x,16));
    const b = hex2.match(/\w\w/g).map(x=>parseInt(x,16));
    const c = a.map((v,i)=>Math.round(v+(b[i]-v)*t));
    return '#'+c.map(v=>v.toString(16).padStart(2,'0')).join('');
  }

  // Score-Farbe berechnen (Grau -> Rot basierend auf Score)
  {% if report and report.escalation_result and report.escalation_result.escalation_score %}
  const score = {{ report.escalation_result.escalation_score.score }};
  const t = (score - 1) / 9;
  const colorNow = lerpColor('94a3b8', 'dc2626', Math.min(1,Math.max(0,t)));

  // Score-Farbe anwenden
  document.getElementById("scoreBig").style.color = colorNow;

  // Current level markieren - gesamten Text einfärben
  const currentLevel = Math.floor(score);
  const scaleElements = document.querySelectorAll('.scale-text .is-current');
  scaleElements.forEach(el => {
    el.style.color = colorNow;
    // Alle child elements (spans) ebenfalls einfärben für einheitliche Darstellung
    const spans = el.querySelectorAll('span');
    spans.forEach(span => {
      span.style.color = colorNow;
    });
  });

  {% else %}
  // Fallback: Score 1.0 in grau
  document.getElementById("scoreBig").style.color = '#94a3b8';
  {% endif %}

  // Helper: Strip HTML tags from LLM output
  function stripHtmlTags(text) {
    return text.replace(/<[^>]*>/g, '');
  }

  // Render Trend Markdown (strip HTML tags from LLM)
  const trendDataEl = document.getElementById('trendData');
  if (trendDataEl) {
    const trendRaw = JSON.parse(trendDataEl.textContent);
    const trendClean = stripHtmlTags(trendRaw);
    document.getElementById('trendContent').innerHTML = marked.parse(trendClean);
  }

  // Render Summary Markdown (nach marked.js geladen ist)
  const summaryDataEl = document.getElementById('summaryData');
  if (summaryDataEl) {
    const summaryMarkdown = JSON.parse(summaryDataEl.textContent);
    document.getElementById('summaryContent').innerHTML = marked.parse(summaryMarkdown);
  }

  // Render Dimension Rationales (strip HTML tags + Markdown)
  document.querySelectorAll('.dim-accordion-body[data-rationale-md]').forEach(body => {
    const rationaleRaw = JSON.parse(body.dataset.rationaleMd);
    const rationaleClean = stripHtmlTags(rationaleRaw);
    body.innerHTML = marked.parse(rationaleClean);
  });
</script>
</body>
</html>